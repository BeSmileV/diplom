\subsubsection{Последовательная диаграмма работы модуля Chats}
Модуль «Chats» обеспечивает обмен сообщениями в реальном времени между пользователями системы (преподавателями и студентами) посредством WebSocket-соединения. Ниже на рисунке~\ref{fig:chats-flow} приведена последовательная диаграмма, демонстрирующая ключевые этапы работы чата: открытие приложения, выбор беседы, отправка и приём сообщений, а также обработку истечения JWT и повторное подключение.

На рисунке~\ref{fig:chats-flow} выделены следующие этапы:

\begin{enumerate}
    \item \textbf{Открытие приложения:}
    \begin{itemize}
        \item пользователь переходит в раздел «Чаты», UI боковой панели запрашивает и отображает список доступных бесед (из кэша или по HTTP),
        \item при загрузке страницы «Чат» UI извлекает \texttt{access\_token} из защищённой cookie (AuthJS),
        \item после получения токена устанавливается WebSocket-соединение с сервером, передавая JWT в заголовке, бэкенд подтверждает подключение.
    \end{itemize}

    \item \textbf{Выбор чата в боковой панели:}
    \begin{itemize}
        \item пользователь кликает на одну из бесед (параметр \texttt{chatId}), боковая панель передаёт этот \texttt{chatId} компоненту «Чат»,
        \item UI «Чат» выполняет HTTP GET-запрос к эндпоинту \texttt{/chats/\{chatId\}/messages?page=1} для получения первой страницы сообщений,
        \item бэкенд возвращает список сообщений, которые UI отображает в области истории сообщений.
    \end{itemize}

    \item \textbf{Отправка нового сообщения:}
    \begin{itemize}
        \item пользователь пишет текст сообщения и нажимает «Отправить» в UI «Чат»,
        \item UI «Чат» эмиттит событие \texttt{send\_message} по WebSocket, передавая объект \{\texttt{chat: chatId, message: \{\ldots\}}\},
        \item бэкенд принимает событие, сохраняет сообщение и возвращает подтверждение приёма,
        \item UI «Чат» временно отображает отправленное сообщение (optimistic UI) со статусом «отправляется» до получения фактического сообщения от сервера.
    \end{itemize}

    \item \textbf{Получение нового сообщения (\texttt{new\_message}):}
    \begin{itemize}
        \item когда любой участник (в том числе другой пользователь) отправляет сообщение, сервер по WebSocket рассылает событие \texttt{new\_message} всем подписанным участникам данного чата,
        \item UI «Чат» получает событие \texttt{new\_message \{ chat, message \}} и добавляет новое сообщение в конец списка истории,
        \item боковая панель получает обновлённый \texttt{chatId} для обновления списка бесед (например, переставить текущую беседу наверх) и отображает актуальный список чатов с учётом новых сообщений.
    \end{itemize}

    \item \textbf{Редактирование сообщения (\texttt{edit\_message}):}
    \begin{itemize}
        \item если пользователь (автор сообщения) редактирует ранее отправленное сообщение, UI «Чат» отправляет серверу по WebSocket событие \texttt{edit\_message \{ chat, message \}},
        \item сервер обновляет текст сообщения и рассылает событие \texttt{edit\_message} всем участникам беседы,
        \item UI «Чат» находит сообщение по его \texttt{id} или \texttt{local\_id} и обновляет текст,
        \item после этого боковая панель получает сигнал «передать chatId» для обновления порядка бесед и отображает обновлённый список чатов.
    \end{itemize}

    \item \textbf{Отметка сообщения как прочитанного (\texttt{read\_message}):}
    \begin{itemize}
        \item когда пользователь прокручивает историю и дожидается видимости новых сообщений, UI «Чат» отправляет событие \texttt{read\_message \{ chat, message \}} по WebSocket,
        \item сервер обновляет статус сообщения на «прочитано» и уведомляет других участников через событие \texttt{read\_message},
        \item UI «Чат» и боковая панель получают это событие, обновляют статус соответствующего сообщения и обновляют отображение списка чатов (например, убрать бейдж «новых сообщений»).
    \end{itemize}

    \item \textbf{Обработка истечения JWT и переподключение:}
    \begin{itemize}
        \item если при работе WebSocket возникает ошибка авторизации (например, \texttt{access\_token} истёк), UI «Чат» получает событие \texttt{connect\_error} от библиотеки Socket.IO,
        \item компонент проверяет поле \texttt{exp(access\_token)} локально, при истечении:
        \begin{enumerate}
            \item UI «Чат» отправляет \texttt{refresh\_token} на AuthJS/Next.js, получая новый \texttt{access\_token},
            \item после получения нового токена выполняется повторное подключение WebSocket, передавая обновлённый JWT,
            \item сервер WebSocket подтверждает новый сеанс подключения.
        \end{enumerate}
        \item боковая панель и UI «Чат» возобновляют подписку на события и продолжают обмен сообщениями без потери данных.
    \end{itemize}
\end{enumerate}

Таким образом, последовательная диаграмма на рисунке~\ref{fig:chats-flow} отражает полный цикл работы модуля «Chats»: от открытия приложения и установления защищённого соединения до приёма, отправки, редактирования и пометки сообщений, а также автоматического обновления JWT и переподключения WebSocket. Все события обрабатываются как в компоненте UI «Чат», так и в боковой панели, чтобы гарантировать актуальность списка бесед и статусов сообщений.
